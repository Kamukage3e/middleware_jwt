name: Conditional Workflow for Testing

on:
  workflow_dispatch:
    inputs:
      environments:
        description: 'Enter comma-separated environments (e.g., "mona,sona,lisa")'
        required: true
        type: string
      runner:
        description: 'GitHub Actions runner'
        required: true
        type: string
        default: ubuntu-22.04

jobs:
  setup:
    runs-on: ${{ inputs.runner }}
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set matrix from input
        id: set-matrix
        run: |
          INPUT="${{ github.event.inputs.environments }}"
          # Remove trailing comma if present
          INPUT="${INPUT%,}"
          # Replace commas with '","' and wrap each element with quotes
          JSON_ARRAY="\"${INPUT//, /\",\"}\""
          echo "matrix=[$JSON_ARRAY]" >> $GITHUB_OUTPUT


  build:
    needs: setup
    runs-on: ${{ inputs.runner }}
    strategy:
        fail-fast: false
        matrix:
          environment: ${{ fromJson(needs.setup.outputs.matrix) }}
    outputs:
        successful-envs: ${{ join(steps.collect-envs.outputs.envs, ',') }}
    steps:
      - name: Check echo from matrix
        run: echo "${{ matrix.environment }}"

      - name: Simulate Task Success
        id: task
        run: |
            if [ "${{ matrix.environment }}" == "mona" ] || [ "${{ matrix.environment }}" == "sona" ]; then
            echo "${{ matrix.environment }}" >> $GITHUB_ENV/successful-envs.txt
            echo "::set-output name=env::${{ matrix.environment }}"
            else
            echo "::set-output name=env::"
        
      - name: Collect successful environments
        id: collect-envs
        run: |
            if [ -f $GITHUB_ENV/successful-envs.txt ]; then
            ENV_OUTPUT=$(cat $GITHUB_ENV/successful-envs.txt | tr '\n' ',')
            echo "::set-output name=envs::$ENV_OUTPUT"
            fi


  deploy:
    needs: build
    runs-on: ${{ inputs.runner }}
    strategy:
      fail-fast: false
      matrix:
        environment: ${{ fromJson(needs.build.outputs.successful-envs) }}
    if: ${{ fromJson(needs.build.outputs.successful-envs) }}
    steps:
      - name: Deploy for Successful Environments
        run: |
          echo "Deploying to environment: ${{ matrix.environment }}"
          # Insert deployment commands here

